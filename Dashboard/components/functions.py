import plotly.graph_objs as go
import numpy as np
import json
import os


def update_graph(model, affichage):
    
    # lecture des données json
    path = os.getcwd() + "\\data\\"
    file = path+model
        
    with open(file, 'r') as f:
      data = json.load(f)
      
    # paramètres utilisés (pour les afficher)
    len_gen = 52
    years = []
    mean_distrib = 10
    min_surf = 2
    max_it = 2
    forward_year = 200
    
    if affichage == "var":
        #title = "Model 2 - surfaces with a minimal surface of {}, a cut interval of {} years simulated on {} years".format(min_surf, max_it, forward_year)
        title = "Evolution de la surface à couper chaque année & variance"
        surf=[]
        for year in data:
            years.append(year)
            surf.append(sum(data[year]))

        fig = go.Figure()

        fig.add_trace(go.Bar(x=years, y=surf, marker_line_width=1.5, width=1, name='Distribution'))
        fig.add_trace(go.Scatter(x=years[:len(surf)-len_gen], y=[np.var(surf[k:k+len_gen]) for k in range(len(surf)-len_gen)], name='Variance'))
        fig.add_trace(go.Scatter(x=years, y=[mean_distrib for k in surf], name='Objectif'))
        fig.update_layout(title=title)
    
        return fig
    
    else :
        #title = "Model 2 - surfaces with a minimal surface of {}, a cut interval of {} years simulated on {} years".format(min_surf, max_it, forward_year)
        title = "Evolution de la surface à couper chaque année avec l'âge des arbres"
        surf = []
        for year in data:
            years.append(year)
            surf.append(data[year])
        surf=np.array(surf).reshape(len(years), 2*max_it+1)

            
        fig = go.Figure()

        for i in range(2*max_it+1):    
            fig.add_trace(go.Bar(x=years, y=surf[:, i], marker_line_width=1.5, width=1, name='Age de coupe : '+str(len_gen-i)))
            fig.update_layout(barmode='stack')
            fig.update_layout(title=title)
            
        return fig



def lancer_calcul(model, value1, value2, value3, value4, value5, value6, value7, value8, value9):
    
    #-------------------A MODIFIER AU PREMIER LANCEMENT----------------------------
    ProjectPath = os.getcwd()[:-10] #Chemin d'acces du projet

    Python_Syntaxe="python"  #mot clef pour lancer vos commandes python (peut être py ou autre)
    #-----------------------------------------------------------------------------
    
    modelPath={"model2":".\\Models\\mainModel2.py",
               "model3":".\\Models\\mainModel3.py",
               "model3bis":".\\Models\\mainModel3_bis.py",
               "model3pic":".\\Models\\mainModel3Pic.py",
               "modelcombination":".\\Models\\ModelsCombination.py",
               "ModelsCombinationSerie":".\\Models\\ModelsCombinationSerie.py",
               "ModelsCombinationPic":".\\Models\\ModelsCombinationPic.py",
               "CVXOPTmodel3":".\\CVXOPT\\mainModel3.py",
               "CVXOPTmodelcombination":".\\CVXOPT\\ModelsCombination.py",
               "CVXOPTModelsCombinationQuadratique":".\\CVXOPT\\ModelsCombination_quadratique.py",
               "CVXOPTModelsCombinationSerie":".\\CVXOPT\\ModelsCombinationSerie.py"
               }
    #clés des différents modèles

    #------------------------------------PARAMETRES--------------------------------
    forward_year = value1
    method = value2 #modifie le solveur du modèle 2 (0 pour le recuit simulé, 1 pour la manière déterministe ou 2 pour l'algorithme génétique), par défaut 0
    max_it = value3
    min_surf = value4
    max_iter = value5
    minimize_coupe_generation = value6
    age_cab = value7
    start_year = value8
    frequence = value9


    simulation = forward_year
    min_surface = min_surf
    delta = max_it

    model2_time = 110
    data_preprocessing = "optimise2"
    normalization = 1
    test_min_max = True
    #------------------------------------------------------------------------------

    path = modelPath[str(model)]
    cmd=''
    
    op_system = os.name
    if op_system == "nt":
        cmd1 = "venv\\Scripts\\activate"
        cmd2 = "set PYTHONPATH=%PYTHONPATH%;"+str(ProjectPath)
        separator = " & "
    else:
        cmd1 = "source venv/bin/activate"
        cmd2 = "export PYTHONPATH='" + str(ProjectPath) +"'"
        separator = " && "
    
    
    if path==".\\Models\\mainModel2.py":
        cmd = Python_Syntaxe + " -m virtualenv venv" + separator + cmd1 + separator + "cd " + str(ProjectPath) + separator + cmd2 + separator +"python .\\Models\\mainModel2.py --forward_year "+str(forward_year)+" --model "+str(method)+" --max_it "+str(max_it)+" --min_surf "+str(min_surf)+" --max_iter "+str(max_iter)+" --minimize_coupe_generation "+str(minimize_coupe_generation)
    
    if path==".\\Models\\mainModel3.py":
        cmd = Python_Syntaxe + " -m virtualenv venv" + separator + cmd1 + separator + "cd " + str(ProjectPath) + separator + cmd2 + separator +"python .\\Models\\mainModel3.py --simulation "+str(simulation)+" --delta "+str(delta)+" --min_surface "+str(min_surface)+" --age_cab "+str(age_cab)
    
    if path==".\\Models\\mainModel3_bis.py":
        cmd = Python_Syntaxe + " -m virtualenv venv" + separator + cmd1 + separator + "cd " + str(ProjectPath) + separator + cmd2 + separator +"python .\\Models\\mainModel3_bis.py --simulation "+str(simulation)+" --delta "+str(delta)+" --min_surface "+str(min_surface)+" --age_cab "+str(age_cab)
    
    if path==".\\Models\\mainModel3Pic.py":
        cmd = Python_Syntaxe + " -m virtualenv venv" + separator + cmd1 + separator + "cd " + str(ProjectPath) + separator + cmd2 + separator +"python .\\Models\\mainModel3pic.py --simulation "+str(simulation)+" --delta "+str(delta)+" --min_surface "+str(min_surface)+" --age_cab "+str(age_cab)
    
    if path==".\\Models\\ModelsCombination.py":
        cmd = Python_Syntaxe + " -m virtualenv venv" + separator + cmd1 + separator + "cd " + str(ProjectPath) + separator + cmd2 + separator +"python .\\Models\\ModelsCombination.py --forward_year "+str(simulation)+" --start_year "+str(start_year)+" --age_cab "+str(age_cab)+" --model " +str(method)+" --max_it "+ str(max_it)+" --min_surf "+str(min_surf)+" --model2_time "+str(model2_time)
        
    if path==".\\Models\\ModelsCombinationSerie.py":
        cmd = Python_Syntaxe + " -m virtualenv venv" + separator + cmd1 + separator + "cd " + str(ProjectPath) + separator + cmd2 + separator +"python .\\Models\\ModelsCombinationSerie.py --forward_year "+str(simulation)+" --start_year "+str(start_year)+" --age_cab "+str(age_cab)+" --model "+str(method)+" --max_it "+str(max_it)+" --min_surf "+str(min_surf)+" --frequence "+str(frequence)   
        
    if path==".\\Models\\ModelsCombinationPic.py":
        cmd = Python_Syntaxe + " -m virtualenv venv" + separator + cmd1 + separator + "cd " + str(ProjectPath) + separator + cmd2 + separator +"python .\\Models\\ModelsCombinationPic.py --forward_year "+str(simulation)+" --start_year "+str(start_year)+" --age_cab "+str(age_cab)+" --model "+str(method)+" --max_it "+str(max_it)+" --min_surf "+str(min_surf) 
    
    if path==".\\CVXOPT\\mainModel3.py":
        cmd = Python_Syntaxe + " -m virtualenv venv" + separator + cmd1 + separator + "cd " + str(ProjectPath) + separator + cmd2 + separator +"python .\\CVXOPT\\mainModel3.py --simulation "+str(simulation)+" --age_cab "+str(age_cab)+" --delta "+str(delta)+" --min_surface "+str(min_surf)
    
    if path==".\\CVXOPT\\ModelsCombination.py":
        cmd = Python_Syntaxe + " -m virtualenv venv" + separator + cmd1 + separator + "cd " + str(ProjectPath) + separator + cmd2 + separator +"python .\\CVXOPT\\ModelsCombination.py --forward_year "+str(simulation)+" --start_year "+str(start_year)+" --age_cab "+str(age_cab)+" --model "+str(method)+" --delta "+str(delta)+" --min_surf "+str(min_surf)+" --model2_time "+str(model2_time)+" --data_preprocessing "+ str(data_preprocessing) +" --normalization "+str(normalization)  
    
    if path==".\\CVXOPT\\ModelsCombination_quadratique.py":
        cmd = Python_Syntaxe + " -m virtualenv venv" + separator + cmd1 + separator + "cd " + str(ProjectPath) + separator + cmd2 + separator +"python .\\CVXOPT\\ModelsCombination_quadratique.py"+" --forward_year "+str(forward_year)+" --start_year "+str(start_year)+" --age_cab "+str(age_cab)+" --model "+str(method)+" --min_surf "+str(min_surf)+" --model2_time "+str(model2_time)+" --data_preprocessing "+ str(data_preprocessing) +" --normalization "+str(normalization)   
      
    if path==".\\CVXOPT\\ModelsCombinationSerie.py":
        cmd = Python_Syntaxe + " -m virtualenv venv" + separator + cmd1 + separator + "cd " + str(ProjectPath) + separator + cmd2 + separator +"python .\\CVXOPT\\ModelsCombinationSerie.py"+" --forward_year "+str(forward_year)+" --start_year "+str(start_year)+" --age_cab "+str(age_cab)+" --model "+str(method)+" --min_surf "+str(min_surf)+" --test_min_max " + str(test_min_max) +" --data_preprocessing "+ str(data_preprocessing)

    return cmd